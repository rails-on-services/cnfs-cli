---
version: '<%= compose_version %>'
<%# binding.pry %>
services:<% @config.profiles.each do |profile| %><% xname = profile.eql?('server') ? '' : "_#{profile}" %>
  <%= @service %><%= xname %>:
    labels:
      platform.name: <%= platform.name %>
      platform.env: <%= platform.env %>
      platform.profile: <%= platform.profile %>
      platform.feature_set: <%= platform.feature_set %>
      platform.partition: <%= platform.partition %>
      platform.component: <%= platform.component %>
      platform.resource:  <%= platform.resource %>
      service.name: <%= @service %>
      service.profile: <%= profile %>
      service.type: <%= is_cnfs_service ? 'ros' : 'prop' %>
    image: "${IMAGE_REPOSITORY}/<%= @service %>:${IMAGE_TAG}"<% if profile.eql?('server') %>
    command: ["bundle", "exec", "rails", "server", "-b", "0.0.0.0", "-P", "/tmp/server.pid"]<% elsif profile.eql?('worker') %>
    command: ["bundle", "exec", "sidekiq",<% if is_cnfs_service %> "-r", "spec/dummy",<% end %> "-C", "config/sidekiq.yml"]<% elsif profile.eql?('sqs_worker') %>
    command: ["bundle", "exec", "shoryuken", "-r", "./app/workers/aws", "-C", "config/shoryuken.yml"]<% end %>
    env_file:<% env_files.each do |env_file| %>
      - <%= env_file %><% end %>
    depends_on:
      - wait
    tty: true
    stdin_open: true<% if profile.eql?('server') %>
    ports:
      # - "1234:1234"
      # - "9876" # druby for pry-remote
      - "3000"<% end %><% if @config.mount %>
    volumes:
      - type: bind
        source: "${<%= context_dir %>}/services/<%= @service %>"
        target: "/home/rails/services/app"
        consistency: consistent
      - type: bind
        source: "${<%= context_dir %>}/lib"
        target: "/home/rails/lib"
        consistency: consistent
      - type: bind
        source: "${<%= context_dir %>}/sre"
        target: "/home/rails/sre"
        consistency: consistent<% if mount_cnfs %>
      - type: bind
        source: "${ROS_CONTEXT_DIR}/lib"
        target: "/home/rails/ros/lib"
        consistency: consistent<% end %><% end %>
    build:
      context: "${<%= context_dir %>}"
      args:<% build_args.each_pair do |name, value| %>
        <%= name %>: <%= value.is_a?(Array) ? value.join(' ') : value %><% end %>
        project: <%= @service %>
        GEM_SERVER: "${GEM_SERVER:-https://rubygems.org}"
        PUID: "${PUID:-1000}"
        PGID: "${PGID:-1000}"
<% end %>
