# rails/compose.yml.erb
<%-
def context_path; service.context_path(relative_path) end

def mount_cnfs; (!Cnfs.services_project? and !service.is_cnfs_service) end
-%>
---
version: '<%= version %>'
services:<% service.profiles.each do |profile| %><% xname = profile.eql?('server') ? '' : "_#{profile}" %>
  <%= service.name %><%= xname %>:
    labels:
      <%= labels %>
      profile: <%= profile %>
    image: "${IMAGE_REPOSITORY}/<%= service.name %>:${IMAGE_TAG}"
    command: <%= service.command(profile) %><% if env_files.size.positive? %>
    env_file:
      - <%= env_files %><% end %>
    depends_on:
      - wait
    tty: true
    stdin_open: true<% if profile.eql?('server') %>
    ports:
      # - "1234:1234"
      # - "9876" # druby for pry-remote
      - "3000"<% end %><% if mount %>
    volumes:
      - type: bind
        source: "<%= context_path.join("services/#{service.name}") %>"
        target: "/home/rails/services/app"
        consistency: consistent
      - type: bind
        source: "<%= context_path.join('lib') %>"
        target: "/home/rails/lib"
        consistency: consistent
      - type: bind
        source: "<%= context_path.join('sre') %>"
        target: "/home/rails/sre"
        consistency: consistent<% if mount_cnfs %>
      - type: bind
        source: "<%= context_path.join('ros/lib') %>"
        target: "/home/rails/ros/lib"
        consistency: consistent<% end %><% end %><% if profile.eql?('server') %>
    build:
<%# binding.pry %>
      context: "<%= context_path %>"<% if service.build_args(@context.target) %>
      args:<% service.build_args(@context.target).each_pair do |name, value| %>
        <%= name %>: <%= value.is_a?(Array) ? value.join(' ') : value %><% end %>
        project: <%= service.name %>
        GEM_SERVER: "${GEM_SERVER:-https://rubygems.org}"
        PUID: "${PUID:-1000}"
        PGID: "${PGID:-1000}"<% end; end %>
<% end %>
